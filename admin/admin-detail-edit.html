<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editace záznamu</title>
  <script type="module" src="./modules/firebase-init.js"></script>
  <script type="module" src="./modules/helpers.js"></script>
  <script type="module" src="./modules/actions.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      padding: 2rem;
    }
    form {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      max-width: 600px;
      margin: auto;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 90vh;
    }
    input, textarea, select {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    label {
      font-weight: bold;
      margin-top: 1rem;
    }
    .form-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: auto;
    }
    .form-buttons button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <form id="editForm">
    <h1>Editace záznamu</h1>

    <label for="imageUrl">Adresa obrázku</label>
    <input type="url" id="imageUrl" required>

    <label for="category">Kategorie</label>
    <select id="category" required>
      <option value="Ostatní">Ostatní</option>
      <option value="Potraviny">Potraviny</option>
      <option value="Motorová vozidla">Motorová vozidla</option>
      <option value="Bydlení">Bydlení</option>
      <option value="Šaty">Šaty</option>
      <option value="Sportovní potřeby">Sportovní potřeby</option>
      <option value="Elektronika">Elektronika</option>
    </select>

    <label for="price">Cena (Kč)</label>
    <input type="number" id="price" min="0">

    <label for="description">Popis</label>
    <textarea id="description" required></textarea>

    <label for="fromDate">Zobrazit od</label>
    <input type="date" id="fromDate" required>

    <label for="toDate">Zobrazit do</label>
    <input type="date" id="toDate" required>

    <div class="form-buttons">
      <button type="submit">Uložit</button>
      <button type="button" id="archiveBtn">Archivovat</button>
      <button type="button" onclick="deleteItem()">Vymazat</button>
      <a href="/admin/admin-bilder.html"><button type="button">Zpět na Admin</button></a>
    </div>
  </form>

  <script type="module">
    import { db, ref, update, onValue, remove } from './modules/firebase-init.js';
    import { getItemById } from './modules/helpers.js';
    import { deleteItem, archiveItem, activateItem } from './modules/actions.js';

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const form = document.getElementById("editForm");
    const imageUrl = document.getElementById("imageUrl");
    const category = document.getElementById("category");
    const price = document.getElementById("price");
    const description = document.getElementById("description");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const archiveBtn = document.getElementById("archiveBtn");

    function fillForm(data) {
      imageUrl.value = data.imageUrl || "";
      category.value = data.category || "Ostatní";
      price.value = data.type === "zbozi" ? (data.price || 0) : "";
      description.value = data.description || "";
      fromDate.value = data.fromDate || "";
      toDate.value = data.toDate || "";

      if (data.archive === true || data.toDate < new Date().toISOString().split("T")[0]) {
        archiveBtn.textContent = "Aktivovat";
        archiveBtn.onclick = () => activateItem(id);
      } else {
        archiveBtn.textContent = "Archivovat";
        archiveBtn.onclick = () => archiveItem(id);
      }
    }

    if (id) {
      getItemById(id, fillForm);
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      const updated = {
        imageUrl: imageUrl.value,
        category: category.value,
        price: parseFloat(price.value) || 0,
        description: description.value,
        fromDate: fromDate.value,
        toDate: toDate.value
      };
      const itemRef = ref(db, `items/${id}`);
      update(itemRef, updated).then(() => {
        alert("Záznam byl uložen.");
      });
    });
  </script>
</body>
</html>
