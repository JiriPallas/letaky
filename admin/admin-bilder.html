<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin - Aktivní položky</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script type="module" src="./data-utils.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f4f4f4; }
    .card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    img { max-width: 100%; max-height: 120px; margin-bottom: 0.5rem; border-radius: 5px; }
    button { margin: 0.3rem; padding: 0.4rem 0.8rem; }
    canvas.qr { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>Aktivní položky</h1>
  <div id="gallery">Načítání...</div>

  <script type="module">
    import { firebaseApp, db, isValidItem } from './data-utils.js';
    import { get, ref, set } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js';

    const gallery = document.getElementById('gallery');

    const snapshot = await get(ref(db, '/'));
    const data = snapshot.val() || {};

    const uploads = Object.entries(data)
      .filter(([id, item]) => item && item.archived !== true && isValidItem(item))
      .map(([id, item]) => ({ id, ...item }));

    gallery.innerHTML = '';

    uploads.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.src = item.imageUrl;
      img.alt = item.description;

      const info = document.createElement('div');
      info.innerHTML = `
        <strong>${item.description}</strong><br>
        ${item.category}<br>
        ${item.fromDate} – ${item.toDate}<br>
        ${item.type === 'zbozi' && item.price ? 'Cena: ' + item.price + ' Kč' : ''}
      `;

      const qr = document.createElement('canvas');
      new QRious({ element: qr, value: `${location.origin}/detail.html?id=${item.id}`, size: 100 });

      const save = document.createElement('button');
      save.textContent = 'Uložit obrázek';
      save.onclick = () => {
        const a = document.createElement('a');
        a.href = item.imageUrl;
        a.download = 'kupon.jpg';
        a.click();
      };

      const buy = document.createElement('button');
      buy.textContent = 'Koupit';
      buy.onclick = () => window.open('https://example.com', '_blank');

      const share = document.createElement('button');
      share.textContent = 'Sdílet';
      share.onclick = () => navigator.share?.({
        title: item.description,
        text: item.category,
        url: `${location.origin}/detail.html?id=${item.id}`
      }) ?? alert('Sdílení není podporováno.');

      const archive = document.createElement('button');
      archive.textContent = 'Archivovat';
      archive.onclick = async () => {
        item.archived = true;
        await set(ref(db, `/${item.id}`), item);
        location.reload();
      };

      card.append(img, info, qr, save, share);
      if (item.type === 'zbozi') card.appendChild(buy);
      card.appendChild(archive);
      gallery.appendChild(card);
    });
  </script>
</body>
</html>
