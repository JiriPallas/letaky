<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Aktivn√≠ polo≈æky</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    h1 { text-align: center; }
    .top-bar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .card {
      background: white;
      padding: 0.8rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 0.9rem;
    }
    img {
      max-width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    button {
      margin: 0.2rem;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      width: 90%;
    }
    canvas.qr {
      margin-top: 0.5rem;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>

<div class="top-bar">
  <button onclick="location.href='index.html'">Zpƒõt do Admin</button>
  <button onclick="location.href='admin-json-editor.html'">Editovat Data (JSON)</button>
</div>

<h1>Aktivn√≠ polo≈æky</h1>
<div class="grid" id="gallery">Naƒç√≠t√°n√≠...</div>

<script>
  // üî• Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCFlTsn1ESQddd_7Neq-W6LBGRiT92c-5w",
    authDomain: "letaky-aa6ab.firebaseapp.com",
    databaseURL: "https://letaky-aa6ab-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "letaky-aa6ab",
    storageBucket: "letaky-aa6ab.appspot.com",
    messagingSenderId: "814346215288",
    appId: "1:814346215288:web:445f9700dac9b81cd8f28d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  async function loadData() {
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';

    try {
      const snapshot = await db.ref().get();
      const data = snapshot.val();

      if (!data || typeof data !== 'object') {
        gallery.textContent = '≈Ω√°dn√° data nenalezena.';
        return;
      }

      Object.entries(data)
        .filter(([_, obj]) => obj.archived !== true)
        .forEach(([key, obj]) => {
          const card = document.createElement('div');
          card.className = 'card';

          const img = document.createElement('img');
          img.src = obj.imageUrl || '';
          img.alt = obj.description;

          const desc = document.createElement('div');
          desc.innerHTML = `<strong>${obj.description || 'Popis nezn√°m√Ω'}</strong>`;

          const info = document.createElement('div');
          info.innerHTML = `${obj.category || ''}<br>${obj.fromDate || ''} ‚Äì ${obj.toDate || ''}`;

          const price = obj.type === 'zbozi' && obj.price
            ? document.createElement('div')
            : null;
          if (price) price.textContent = `Cena: ${obj.price} Kƒç`;

          const qr = document.createElement('canvas');
          qr.className = 'qr';
          new QRious({
            element: qr,
            value: `${location.origin}/detail.html?id=${key}`,
            size: 100
          });

          const saveBtn = document.createElement('button');
          saveBtn.textContent = 'Ulo≈æit obr√°zek';
          saveBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = obj.imageUrl;
            a.download = 'kupon.jpg';
            a.click();
          };

          const buyBtn = document.createElement('button');
          buyBtn.textContent = 'Koupit';
          buyBtn.onclick = () => {
            alert('Zde bude platebn√≠ odkaz.');
          };

          const shareBtn = document.createElement('button');
          shareBtn.textContent = 'Sd√≠let';
          shareBtn.onclick = async () => {
            if (navigator.share) {
              await navigator.share({
                title: obj.description,
                url: `${location.origin}/detail.html?id=${key}`
              });
            } else {
              alert('Sd√≠len√≠ nen√≠ podporov√°no ve va≈°em prohl√≠≈æeƒçi.');
            }
          };

          const archiveBtn = document.createElement('button');
          archiveBtn.textContent = 'Archivovat';
          archiveBtn.onclick = async () => {
            if (confirm('Opravdu archivovat tuto polo≈æku?')) {
              await db.ref(key).update({ archived: true });
              alert('Polo≈æka archivov√°na.');
              loadData();
            }
          };

          card.appendChild(img);
          card.appendChild(desc);
          card.appendChild(info);
          if (price) card.appendChild(price);
          card.appendChild(qr);

          if (obj.type === 'letak') card.appendChild(saveBtn);
          if (obj.type === 'zbozi') card.appendChild(buyBtn);

          card.appendChild(shareBtn);
          card.appendChild(archiveBtn);

          gallery.appendChild(card);
        });

    } catch (err) {
      console.error(err);
      gallery.textContent = 'Nepoda≈ôilo se naƒç√≠st polo≈æky.';
    }
  }

  loadData();
</script>

</body>
</html>
